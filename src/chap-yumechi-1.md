---
class: chapter
---

# 過去の画像データをなるべく軽くして保管したい！

フィーチャーフォン時代に撮った写真がたまたま出てきて、びっくりしてしまう yumechi です。
フィーチャーフォン時代から考えるとすでに20年分くらいの写真（画像データ）が手元にあります。
今回はこちらのデータ管理について試行錯誤した点を書いていきます。


なお実作業自体は5年位前にPCを買い替えるタイミングで行っているので、内容が若干古いことはご了承ください。

## 大量の画像データ vs ストレージ

当時画像データを主に管理していた PC は MacBook Air の SSD 128GB モデルでかなり容量的にギリギリでした。外付けの HDD なども利用してやりくりしていました。


バックアップは OneDrive を利用していました。
OneDrive は昔から使っているユーザーは少しだけ無料枠のストレージが大きいこともあり、割と気軽にバックアップしていました。


注意すべき点として、昨今の画像データのサイズは過去のものと比べ物にならないくらい大きいことがあります。
2010年ごろのフィーチャーフォンの画像データは数百KB程度のものがほとんどですが、2020年ごろともなると10MBを超えてくるような画像データもあります。
このサイズの画像データが今後増えていくと考えると、無料枠のストレージでは足りなくなってくることが予想されます。

そこで当時私は次のように考えました。

- 過去のデータについては参照回数が極端に低いので、画質を落とすことやファイル形式の変更なども視野に入れて対応する
- 特に iPhone の HEIC[^heic] などのデータ形式は容量が大きいため、WebP などほかの形式に置き換えて容量を削減する
- ファイル数分ダウンロード・アップロードを行うと時間がかかるため、参照が少なくなっている過去データについてはある程度圧縮してアップロードする
    - ただし画像データの圧縮は容量的にはほとんど変わらないため、ファイルをまとめて扱いやすくするために必要と判断した

以降の章では、その試行錯誤の過程を書いていきます。

## 画質を落とす・ファイル形式の変更を行う

手元にある画像データのデータ形式は JPEG, PNG, HEIC などがありました。

容量のことを考えると JPEG が最適ですが、JPEG は非可逆圧縮であるため、画質を落とすと元に戻すことができません。もとから小さい画像をさらに小さな JPEG に変換すると視認性が非常に悪くなるため、 JPEG で保管することは検討から外しました。
また HEIC はファイルサイズが小さいという話も見かけていましたが、実際のデータサイズを見るとかなり大きい状態でした。当時の私の比較検討などによると、画像表示のサポートなども弱く他のフォーマットへ変換する判断になりました。


ここで PNG への変換を考えていたのですが、WebP[^webp] というファイル形式があることも知りました。
WebP は Google が開発しているファイル形式で、JPEG や PNG よりもファイルサイズが小さいという特徴があります。
可逆圧縮も非可逆圧縮もサポートしていることもあり、WebP 形式へ変換することでファイルサイズを削減することができると考えました。


結果として、当時ブラウザのサポート状況なども進んでいることもあり、WebP 形式への変換を行うことにしました。
変換自体は ImageMagick を利用してシェルスクリプトで行いました。画質は 90% くらいにして少し落とした記憶があります。
ただし HEIC からの変換は ImageMagick 単体ではサポートされていません。別途 heif-convert をインストールする必要があります。


今であれば GUI ベースのツールも充実しているのでそれらでできる可能性もあります。
一方で AI などを使ってシェルスクリプトを書いてもらえばできるような気もしており、画像の大量データ変換についてはどういう形がベストなのかは悩みどころですね。

### 実際に画像フォーマットを変更したらどれくらいのサイズになるのか？

実際に画像フォーマットを変更したらどれくらいのサイズになるのか？を別途検証しました。
ベンチマークでランダムな画像を作っているので、実データとは異なる挙動となっている可能性もあります。
参考程度に見てください。

詳細は私が管理している https://github.com/yumechi/datamanagement-image-compression-bench のリポジトリをご確認ください。


結果として、PNG ファイルから WebP ファイルへの変換で約 50% くらいのサイズ削減ができました。
クオリティについては 90% まで落とすと一気に容量が削減されました。
なので、 WebP 形式にしつつ、クオリティは 90% 程度にしておくというのは一つの選択肢となりそうですね。

## データの圧縮を行う

次にデータの圧縮を考えました。
ただし画像データは圧縮することによるメリットをほとんど受けられないため、データをまとめて通信しやすくすることを目的としました。

圧縮する単位としてはフィーチャーフォンを使っていた時代のものはフィーチャーフォンの単位で、それ以降のスマートフォンを持ち始めた以降のものは年度ごとに作成しました。
これはファイルサイズを見たときに GB 単位になるかどうかを見て、年度ごとくらいが妥当だと考えた結果によります。
正確には年度ごとにディレクトリを作成し、その下に月ごとのディレクトリを作成して、ファイルを配置しました。
幸い、ファイル名やメタ情報からこの整理や管理は比較的容易に行うことができました。


その後圧縮形式について考えましたが、どのようにするとファイルサイズを最小にしつつ、扱いやすいかを考えました。
事前条件として下記を考慮しました。

- スマートフォンからは画像を直接操作しないので、常に圧縮した状態で問題ない
- Windows, macOS, Linux などで一度解凍して参照できるようにしたい
    - zip 形式を採用しにくかった理由がここにあり、ファイルパスやファイル名が壊れる問題を懸念しました
- ファイルサイズはなるべく小さくしたい
- 圧縮・解凍時間はバランスを見て考えたい
- メモリ効率も考慮したい
    - メモリ4GBのPCでデータ圧縮などをする必要がありました


その結果、7z 形式[^7zip]を当時は選択しました。
7z 形式は圧縮率が高く、圧縮・解凍時間も比較的速いという特徴があります。
また、主要な OS で広くサポートされており、扱いやすく管理できました。

一方、現在選定しなおすとすれば Zstandard 形式[^zstd]を採用するのが良いかもしれません。ただし当時は少し先取過ぎていて安定するかの懸念が強く、採用を見送りました。
Zstandard 形式は圧縮率が高く、圧縮・解凍時間も非常に速いという特徴があります。
また、主要な OS で広くサポートされており、7z 形式同様に扱いやすく管理できます。

### 実際にデータの圧縮を行ったらどれくらいのサイズ・速度になるのか？

実際にデータの圧縮を行ったらどれくらいのサイズ・圧縮・解凍速度になるのか？を別途検証しました。
ベンチマークではランダムな画像を作っているので、実データとは異なる挙動になるかもしれません。
詳細は私が管理している https://github.com/yumechi/datamanagement-image-compression-bench のリポジトリをご確認ください。


結果として、画像データなどの圧縮を行った場合は画像データ側で十分に圧縮されるため、圧縮・解凍速度はそれほど変わらない印象でした。
一方で、Zstandard を利用した場合は圧縮・解凍速度が非常に速かったため、圧縮・解凍速度のメリットは十分に感じられました。
やはり、今選び直すとすれば Zstandard 形式を採用するのが良いかもしれませんね。


## 実施した結果として

画像データの移行前後のデータサイズがどれくらいだったのかを当時記録していなかったので、記憶ベースとなりますが、数GB程度のデータ圧縮と数時間程度のアップロード時間の短縮ができました。
今後もデータが増えていくことを考えると、この方法は十分に効果があると考えています。

もう少し頑張ってワークフロー的なものを作ってみるのも面白いかもしれませんが、クラウドにバックアップ取りつつも、ほかのバックアップ方法についても検討を並行して進められればと思います。
例えば AWS S3や Cloudflare R2 などのクラウドストレージを利用したり、 NAS を利用してみるのも興味があり、今後の課題となりそうです。

おそらく今後さらに多くのところで画像データの記録や保管については課題になってくると思います。
大切な思い出も残しつつ、今後に備えてデータに詳しくなっておくのもよいかもしれませんね。

[^heic]: HEIC（High Efficiency Image Container）は Apple が iOS 11 以降で採用している画像や動画などのフォーマットです。HEIF（High Efficiency Image Format）をベースにしており、JPEG と比較して同等の画質でファイルサイズの削減を実現しています。https://support.apple.com/ja-jp/116944
[^webp]: WebP は Google が開発しているファイル形式で、JPEG や PNG よりもファイルサイズが小さいという特徴があります。https://developers.google.com/speed/webp?hl=ja
[^7zip]: 7z形式は LZMA/LZMA2 アルゴリズムを採用したオープンなアーカイブ形式で、高い圧縮率が特徴です。https://www.7-zip.org/
[^zstd]: Zstandard は DEFLATE と同等以上の圧縮率を持ちながら、圧縮・解凍速度が非常に速い無損失圧縮アルゴリズムです。https://github.com/facebook/zstd

