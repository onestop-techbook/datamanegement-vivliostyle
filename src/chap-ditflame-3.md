---
class: chapter
---

# ストレージ容量や通信容量が増えると何が嬉しいのか

ストレージ容量や通信容量を増やすと、単に保存したり、通信したりするデータ量が増えるのですが、この**増えたデータ量**を**データを守る事に振り分けると、データを守る**事ができます。

この**データを守る** 技術についても基本論点を押さえておきましょう。

## データを守ろう　その１(パリティ)

データを表現するのに最低限必要なbit数に対し、そのbit数より多いデータ量を割り当てる事でデータを守る事ができます。

まずは簡単な例（パリティ）を見てみましょう。

たとえば8bitのデータ[10101010]があるとして、ここに1bit追加します。この時、追加する1ビットはすべてのビットの総和が奇数であれば1、偶数であれば0とします。

上の例だと総和は4なので、9bitになったデータは[101010100]となります。

これは一般的に「偶数パリティ」と呼ばれる**誤り検出ビット生成方式**で、実はどんなbit列であっても、偶数パリティを含めると全ビットの和は常に偶数になります。

※逆に、常に奇数になるようにする奇数パリティもあります

前述の9bitのデータ[101010100]の5ビット目に通信誤りが仮に発生した[1010**0**0100]とします。

パリティがあれば、この時の通信で受けとったビット列は[1010**0**0100]となり、ビットの総和は奇数になります（つまり誤りがある事がわかる）

※なおこの方式の場合、2ビット以上に誤りが発生すると誤り検出できない(誤りがあるのに、無いとしてしまう)ケースが出ます。

## データを守ろう　その２(ハミング符号)

もっと高度な方法もあります。その代表例がハミング符号です。

今度は4bitのデータ[1001]に3bitを次のルールで足してみます(下図の例だと[100])。

引用 https://emb.macnica.co.jp/articles/13232/

すると、1bitのビット誤りが発生しても誤りを自ら訂正できます(これをハミング符号と呼ぶ)。

なお、前述のパリティビットとハミング符号を組み合わせた、拡張ハミング符号が通信の世界では現実的には良く用いられています。

最近まではデータ通信やストレージで・サーバー用メモリでの採用が主だったが、最新のデスクトップPCで採用されているDDR5メモリ規格からはメモリにもこれらの技術で紹介した誤り訂正を応用した、誤り検出・訂正機能(ECC)が必須となっています。

また、一般的なサーバーグレードではないPCのメモリに対し、誤り検出・訂正機能はこれまで搭載されていなかったのが、なぜ昨今では急に必須となったかというと、コンピューターが一般化し、また半導体プロセスが微細化した現在では、宇宙線に起因する「ソフトエラー」が有意に観測されてしまうため　だそうで、例えば次のような記事が公開されていたりします。

参考　https://journal.ntt.co.jp/article/17465

データを表現するビット以上の冗長なビット数を誤り検知・訂正に割く事で、**何ビットまでのビット誤りが検知でき、何ビットまでのビット誤りが訂正できるか**というのは、一応理論的にも説明ができるのですが、その話を深堀りする事にはあまり意味がないので、本書の記事としては割愛します。

とりあえず利用者観点としては、**誤り訂正にビットを使えば使うほど、誤り訂正能力が上がる**事だけがわかっていれば良いでしょう。

## データを守ろう　その３(トランザクション)

単一の「データ」をより多くのbit数で守る方法についてはここまで説明してきましたが、それ以外にも「データ」を守るためには、気にしないといけないポイントがあります。例えば次のようなケースを考えてみましょう。

A株式会社の会計担当のＹさんは、Ｘさんに費用を支払おうと5000円を送金しました。

この時の処理は

１）A社口座から	-5000円

２）Xさん口座に	+5000円

という処理になります。

この時、送金の途中（1が終わった時点）でもし送金システムがクラッシュしてしまった　と仮定するとどうなるでしょうか？

普通に考えると、こうなりそうです（5000円消えちゃう……）。

A社口座：▲5000円

Xさんの口座：±０円

こういった事態を防ぐために、この時の処理は１，２を同時に行い、両方が終わったタイミングで処理を止め、データを確実に保存する（もしくは両方を巻き戻して開始していない状態で止める）という事をします。

これをトランザクションと呼びます。

データを守るためのソフトウェアの代表格であるデータベースにおいて、トランザクション処理では、次の４つの基本的な特性を保つ必要がある事が知られています。

| 用語 | 説明 |
| ---- | ---- |
| Atomicity(原子性) | すべてのトランザクションが完全に成功するか、失敗するかを保証する |
| Consistency(一貫性) | トランザクションの実行前後でデータベースの整合性が保たれることを保証する |
| Isolation(独立性) | 同時に実行される複数のトランザクションが互いに影響を与えないようにする |
| Durability(永続性) | トランザクションが完了すると、その結果が恒久的にデータベースに保存されることを保証する |

これだけを見ると、ITだけの世界の話に見えますが、例えば現実的な例でいうと複式簿記なんかも考え方としてはトランザクションの一種だと言えます。なぜかというと、複式簿記の記帳は絶対に貸方と借方をセットでバランスするように書くからです。

※そうでないと、貸借対照表(B/S)・損益計算書(P/L)がバランスしなくなります

## データを守ろう　その４(RAID)

ストレージデバイスを複数組み合わせる技術としてRAID（レイド）とよばれるものがあります。

これが書かれた論文で定義された「RAIDレベル」というのが今でも一般的にRAIDの区分になっています。

※論文はRAID5を示すためのものだったので当初はRAID5まで

データの堅牢性を上げ、かつ実際に使われているのはRAID1,5,6なので、これらについても説明します。

RAID1は単に2台のハードディスクに同じデータを書き込むだけです。シンプル。

※１台壊れても大丈夫

RAID5は3台以上のハードディスクの領域をある程度のブロックに分割し、ブロック毎に1つがパリティになるように、かつパリティブロックをストライプ状に配置します。

※１台壊れても大丈夫

RAID6は4台以上のハードディスクの領域をある程度のブロックに分割し、ブロック毎に2つがパリティになるように、かつパリティブロックをストライプ状に配置します。

※２台まで耐える

## データを守ろう　その５(バックアップルール)

「データ」を守るための様々なトピックをだいたいお伝えできたので、やっとバックアップの話に入ります。

バックアップには3-2-1バックアップルールが必要である　と言われて久しいのですが、基本となっているこのルールについてまずは見ていきましょう。

３は「本番用コピーを含め、少なくとも3つのデータコピーを用意すること。」です。

これは、単に１ペアでのバックアップ(※たとえば前述のRAID1など)だと、「誤りがある事はわかるが、正しいデータが何かはわからない」為。

※３つあれば、２つは一致するハズなので正しいデータがわかる

２は「テープとクラウドストレージのように、少なくとも2つの異なるストレージメディアを使用すること。」です。

ストレージメディアを使用することで、特定のストレージメディアを使ったときにそこが単一障害点になるケースを防げる(と言われてます)

※聞いたことのある事例でだと、RAIDコントローラーチップが変に壊れて、正常に動いているふりをして異常データをドライブに書き込み続けたケースや、一定時間稼働すると間違いなく死ぬ(ソフトウェアバグ起因で)ストレージや……

１は「少なくとも1つは、マシンが物理的に破損した場合に備えて、オフサイトで保管すること。」です。

DR(ディザスタリカバリ)やBCP(事業継続計画)的な文脈ですが、この「オフサイト」どれぐらい距離が離れていれば良いのでしょうか？

「オフサイト」の距離については、かつて(東日本大震災前)は国の指針でも50km離せ　とか言っていたのですが、東日本大震災後は500km~1000km離す事が推奨されています。

ここまでの3-2-1バックアップルールでは守れないものが昨今は出てきています。

その代表的なものが

* 誤操作(やソフトウェア不具合)によるデータ破壊
* ランサムウェアによるデータ破壊

です。

前述のデータ破壊に対応できるバックアップルールとして、昨今は「3-2-1-1-0バックアップルール」が提唱されています。

後ろに２ルール増えたのですが、これは何が増えているのでしょうか？

増えた「１」は「少なくとも1つのコピーはオフラインで保管するか、クラウドを使用する場合はイミュータブル（不変）であること。」です。

前者は、オフラインで保管することでランサムウェアなどのネットワーク先にも影響を及ぼすタイプの攻撃からデータを守る事を意図しています。

「クラウドを使用する場合はイミュータブル（不変）であること。」

これはクラウドストレージについても、「イミュータブル（不変） 」としててデータを保存する事ができ、この設定となったストレージでは原則としてデータは消えません(仮に書き換わる処理が入った場合は、過去の履歴も残りつつ、変更後の値も残る)

最後の「０」は「バックアップはエラーゼロで完了すること。」です。

まあこれはマーケティング的な意味合いが強いのですが……（これを言い出したのはVeeamというベンダーなので）

